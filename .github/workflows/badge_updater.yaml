name: Badge Updater

on:
  repository_dispatch:
    types: [badge-update]

jobs:
  badge_file_creator:
    name: Badge File Creator
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v4
      - name: Update badges
        uses: emibcn/badge-action@808173dd03e2f30c980d03ee49e181626088eee8 # ratchet:emibcn/badge-action@v2
        with:
          icon: ${{ github.event.client_payload.icon }}
          icon-width: ${{ github.event.client_payload.icon_width }}
          label: ${{ github.event.client_payload.label }}
          label-color: ${{ github.event.client_payload.label_color }}
          status: ${{ github.event.client_payload.status }}
          color: ${{ github.event.client_payload.status_color }}
          path: ${{ github.event.client_payload.path }}
      - name: Push changes to badges if any
        env:
          GITHUB_TOKEN: ${{ secrets.BOT_TOKEN }}
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            gpg --import <(echo "${{ secrets.BOT_GPG_PRIVATE_KEY_BASE64 }}" | base64 -d)
            git config user.name "github-actions-bot"
            git config user.email "github-actions-bot@users.noreply.github.com"
            git config user.signingkey "${{ secrets.BOT_GPG_KEY_ID }}"
            git config commit.gpgsign true
            git checkout --orphan badges
            # Unstage all the files in working tree
            git rm --cached $(git ls-files)
            git status --porcelain
            git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}
            git commit -am "ci: pin actions and Docker images in workflows"
            git push
          else
            echo "No changes to commit."
          fi
