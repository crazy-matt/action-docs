name: 'Docker Builder'

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: [main]
    paths:
      - 'docker/Dockerfile'
  push:
    branches: [main]
  workflow_dispatch: # Allows you to run this workflow manually from the Actions tab
  schedule:
    # Run every day at 12 pm
    - cron: "0 12 * * *"

defaults:
  run:
    shell: bash

jobs:
  approver:
    name: 'Test'
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' && github.event.action != 'closed') ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      github.event_name == 'push'
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2
      - name: 'Set Job Vars'
        id: vars
        run: |
          echo "::set-output name=task_version::$(cat ${{ github.workspace }}/.tool-versions | grep -w task | cut -d ' ' -f2)"
      - name: 'Install asdf dependencies'
        uses: asdf-vm/actions/install@v1
      - name: 'Install Task'
        uses: arduino/setup-task@v1
        with:
          version: ${{ steps.vars.outputs.task_version }}
      - name: 'Test'
        id: test
        run: |
          task docker:test
          task lint
        env:
          GHCR_TOKEN: ${{ secrets.CI_GH_PAT_CONTAINER_REGISTRY_AUTH }}
      - name: 'Set badge properties'
        id: badge
        if: github.event_name == 'push'
        # icon is svg converted to base64 (https://base64.guru/converter/encode/image/svg)
        run: |
          if [[ "${{ steps.test.outcome }}" == "success" ]]; then
            echo "::set-output name=status::passing"
            echo "::set-output name=status_color::green"
          else
            echo "::set-output name=status::failed"
            echo "::set-output name=status_color::red"
          fi
          echo "::set-output name=icon::data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjIiIGJhc2VQcm9maWxlPSJ0aW55LXBzIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0NiA0NiIgd2lkdGg9IjQ2IiBoZWlnaHQ9IjQ2Ij4KCTx0aXRsZT51c2FiaWxpdHlfdGVzdGluZ19pY29uXzE1MDMyNC1zdmc8L3RpdGxlPgoJPHN0eWxlPgoJCXRzcGFuIHsgd2hpdGUtc3BhY2U6cHJlIH0KCQkuczAgeyBmaWxsOiBub25lO3N0cm9rZTogIzRjNTE1OTtzdHJva2Utd2lkdGg6IDIgfSAKCTwvc3R5bGU+Cgk8ZyBpZD0iaWNvbnMiPgoJCTxnIGlkPSJYTUxJRF80NDZfIj4KCQkJPHBhdGggaWQ9IlhNTElEXzQ1NF8iIGNsYXNzPSJzMCIgZD0ibTIuMiA0My4ydi00MC42YzAtMC4yIDAuMi0wLjMgMC4zLTAuM2g0MGMwLjIgMCAwLjMgMC4yIDAuMyAwLjN2MzMuOSIgLz4KCQkJPHBhdGggaWQ9IlhNTElEXzQ1M18iIGNsYXNzPSJzMCIgZD0ibTIuMyA4LjFoNDAuNSIgLz4KCQkJPHBhdGggaWQ9IlhNTElEXzQ1MV8iIGNsYXNzPSJzMCIgZD0ibTYuMyA1aDIuNyIgLz4KCQkJPHBhdGggaWQ9IlhNTElEXzQ1MF8iIGNsYXNzPSJzMCIgZD0ibTEwLjYgNWgyLjYiIC8+CgkJCTxwYXRoIGlkPSJYTUxJRF80NDlfIiBjbGFzcz0iczAiIGQ9Im0xNC45IDVoMi42IiAvPgoJCQk8cGF0aCBpZD0iWE1MSURfNDQyXyIgY2xhc3M9InMwIiBkPSJtMTIuNCAyMi4yaC01LjF2LTEwLjNoMjkuNnY1LjIiIC8+CgkJCTxwYXRoIGlkPSJYTUxJRF80NDVfIiBjbGFzcz0iczAiIGQ9Im0xNS4yIDMzLjhoLTcuOXYtNy4xaDUuMiIgLz4KCQkJPHBhdGggaWQ9IlhNTElEXzQ2MF8iIGNsYXNzPSJzMCIgZD0ibTQzLjcgNDEuMWwtMi41IDIuNWMtMC4xIDAuMS0wLjIgMC4xLTAuMyAwbC02LjMtNi4zYy0wLjEtMC4xLTAuMS0wLjIgMC0wLjNsMi41LTIuNWMwLjEtMC4xIDAuMi0wLjEgMC4zIDBsNi4zIDYuM2MwIDAuMSAwIDAuMiAwIDAuM3oiIC8+CgkJCTxwYXRoIGlkPSJYTUxJRF80NThfIiBjbGFzcz0iczAiIGQ9Im0zMy4yIDMzLjFsMi4yIDIuMiIgLz4KCQkJPHBhdGggaWQ9IlhNTElEXzQ1NV8iIGNsYXNzPSJzMCIgZD0ibTI1LjggMzYuMmMtNi4wOCAwLTExLTQuOTItMTEtMTFjMC02LjA4IDQuOTItMTEgMTEtMTFjNi4wOCAwIDExIDQuOTIgMTEgMTFjMCA2LjA4LTQuOTIgMTEtMTEgMTF6IiAvPgoJCQk8cGF0aCBpZD0iWE1MSURfNDQzXyIgY2xhc3M9InMwIiBkPSJtMjkuOCAyMi4zbC01LjEgNS4ybC0zLTMiIC8+CgkJPC9nPgoJPC9nPgo8L3N2Zz4="
          echo "::set-output name=icon_width::20"
          echo "::set-output name=label::Tests"
          echo "::set-output name=label_color::555"
          echo "::set-output name=path::tests.svg"
      - name: 'Update badges'
        if: github.event_name == 'push'
        uses: emibcn/badge-action@v1.2.1
        with:
          icon: ${{ steps.badge.outputs.icon }}
          icon-width: ${{ steps.badge.outputs.icon_width }}
          label: ${{ steps.badge.outputs.label }}
          label-color: ${{ steps.badge.outputs.label_color }}
          status: ${{ steps.badge.outputs.status }}
          color: ${{ steps.badge.outputs.status_color }}
          path: ${{ steps.badge.outputs.path }}
      - name: "Check if there are changes"
        id: changes
        if: github.event_name == 'push'
        uses: UnicornGlobal/has-changes-action@v1.0.12
      - name: "Commit-back changes"
        if: steps.changes.outputs.changed == 1
        uses: swinton/commit@v2.0.0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            tests.svg
          commit-message: "update tests.svg"
          ref: refs/heads/badges
  vulnerability_scanner:
    name: 'Vulnerability Scan'
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' && github.event.action != 'closed') ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      github.event_name == 'push'
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2
      - name: 'Set Job Vars'
        id: vars
        run: |
          echo "::set-output name=task_version::$(cat ${{ github.workspace }}/.tool-versions | grep -w task | cut -d ' ' -f2)"
      - name: 'Install asdf dependencies'
        uses: asdf-vm/actions/install@v1
      - name: 'Install Task'
        uses: arduino/setup-task@v1
        with:
          version: ${{ steps.vars.outputs.task_version }}
      - name: 'Scan for Vulnerabilities'
        id: scan
        run: |
          task docker:security -- sarif
          task security -- sarif
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      - name: 'Dedicated Grype scan for SARIF report creation'
        id: scan_grype
        uses: anchore/scan-action@v3.2.0
        with:
          path: "./"
          fail-build: true
          acs-report-enable: true
      - name: 'Upload SARIF reports'
        if: always()
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v1.0.26
        with:
          sarif_file: "./*.sarif"
      - name: 'Set badge properties'
        id: badge
        if: github.event_name == 'push'
        # icon is svg converted to base64 (https://base64.guru/converter/encode/image/svg)
        run: |
          if [[ "${{ steps.scan.outcome }}" == "success" ]]; then
            echo "::set-output name=status::passing"
            echo "::set-output name=status_color::green"
          else
            echo "::set-output name=status::failed"
            echo "::set-output name=status_color::red"
          fi
          echo "::set-output name=icon::data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjIiIGJhc2VQcm9maWxlPSJ0aW55LXBzIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMSAzNiIgd2lkdGg9IjMxIiBoZWlnaHQ9IjM2Ij4KCTx0aXRsZT5zaGllbGRfMTA2NjYwLXN2ZzwvdGl0bGU+Cgk8c3R5bGU+CgkJdHNwYW4geyB3aGl0ZS1zcGFjZTpwcmUgfQoJCS5zMCB7IGZpbGw6ICNmZmI0MDA7c3Ryb2tlOiAjZmZmZmZmO3N0cm9rZS1saW5lY2FwOnJvdW5kO3N0cm9rZS13aWR0aDogMCB9IAoJCS5zMSB7IGZpbGw6ICMwNzBjMmI7c3Ryb2tlOiAjZmZmZmZmO3N0cm9rZS1saW5lY2FwOnJvdW5kO3N0cm9rZS13aWR0aDogMCB9IAoJPC9zdHlsZT4KCTxwYXRoIGlkPSJMYXllciIgZmlsbC1ydWxlPSJldmVub2RkIiBjbGFzcz0iczAiIGQ9Im0xNS41MiAzNWMtMTUuOTMtNi4xNy0xNC40OC0yNy4yLTE0LjQ4LTI3LjJjOS42NCAxLjc4IDE0LjQ4LTYuOCAxNC40OC02LjhjMCAwIDQuODMgOC41OCAxNC40NSA2LjhjMCAwIDEuNDQgMjEuMDMtMTQuNDUgMjcuMnoiIC8+Cgk8cGF0aCBpZD0iTGF5ZXIiIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xhc3M9InMxIiBkPSJtMTAgMTdsMyAzbDgtOGwyIDJsLTEwIDEwbC01LTVsMi0yeiIgLz4KPC9zdmc+"
          echo "::set-output name=icon_width::20"
          echo "::set-output name=label::Vulnerabilities"
          echo "::set-output name=label_color::555"
          echo "::set-output name=path::vulnerability.svg"
      - name: 'Update badges'
        if: github.event_name == 'push'
        uses: emibcn/badge-action@v1.2.1
        with:
          icon: ${{ steps.badge.outputs.icon }}
          icon-width: ${{ steps.badge.outputs.icon_width }}
          label: ${{ steps.badge.outputs.label }}
          label-color: ${{ steps.badge.outputs.label_color }}
          status: ${{ steps.badge.outputs.status }}
          color: ${{ steps.badge.outputs.status_color }}
          path: ${{ steps.badge.outputs.path }}
      - name: "Check if there are changes"
        id: changes
        if: github.event_name == 'push'
        uses: UnicornGlobal/has-changes-action@v1.0.12
      - name: "Commit-back changes"
        if: steps.changes.outputs.changed == 1
        uses: swinton/commit@v2.0.0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            vulnerability.svg
          commit-message: "update vulnerability.svg"
          ref: refs/heads/badges
  releaser:
    name: 'Release'
    runs-on: ubuntu-latest
    needs: [approver, vulnerability_scanner]
    if: |
      (github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      contains(github.event.pull_request.labels.*.name, 'skip-release') == false) ||
      github.event_name == 'schedule'
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2
      - name: 'Set Job Vars'
        id: vars
        run: |
          echo "::set-output name=task_version::$(cat ${{ github.workspace }}/.tool-versions | grep -w task | cut -d ' ' -f2)"
          if [[ github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'force-release') == true ]]; then
            echo "::set-output name=force_release::true"
          else
            echo "::set-output name=force_release::false"
          fi
      - name: 'Install asdf dependencies'
        uses: asdf-vm/actions/install@v1
      - name: 'Install Task'
        uses: arduino/setup-task@v1
        with:
          version: ${{ steps.vars.outputs.task_version }}
      - name: 'Docker Push'
        run: |
          task docker:push
        env:
          GHCR_TOKEN: ${{ secrets.CI_GH_PAT_CONTAINER_REGISTRY_AUTH }}
          FORCE_RELEASE: ${{ steps.vars.outputs.force_release }}
      - name: 'Notify about the build'
        uses: peter-evans/repository-dispatch@v1.1.3
        with:
          token: ${{ secrets.CI_GH_PAT_REPO_DISPATCH_API_AUTH }}
          event-type: slack-notification
          client-payload: '{ "type": "build", "ref": "${{ github.ref }}", "sha": "${{ github.sha }}", "color": "#2EB67D", "title": "📦 ${{ github.repository }} New Image", "message": "Check-out https://github.com/${GITHUB_REPOSITORY}/pkgs/container/${GITHUB_REPOSITORY#*/}" }'
